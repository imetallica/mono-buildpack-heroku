#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> BUILD DIR: ${BUILD_DIR}"
echo "-----> CACHE DIR: ${CACHE_DIR}"
echo "-----> ENV DIR: ${ENV_DIR}"

export MONO_VERSION="mono-4.4.1.0"
export FSHARP_VERSION="4.0.1.1"

MONO_BUILD_PATH="${CACHE_DIR}/obj"
FSHARP_BUILD_PATH="${MONO_BUILD_PATH}/fsharp-${FSHARP_VERSION}"
MONO_INSTALL_PATH="${CACHE_DIR}/rel/mono"
NUGET_INSTALL_PATH="${BUILD_DIR}/.nuget"

MONO_DOWNLOAD_URL="http://download.mono-project.com/sources/mono/${MONO_VERSION}.tar.bz2"
NUGET_DOWNLOAD_URL="https://www.nuget.org/nuget.exe"

echo "-----> PRE: Checking if mono already exists."
if [ ! -d ${MONO_BUILD_PATH} ]; then
  echo "-----> Mono wasn't downloaded. Downloading."
  echo "-----> PRE: Clearing cache files."
  rm -rf ${CACHE_DIR}/*

  echo "-----> STEP: Downloading Mono."
  wget -c ${MONO_DOWNLOAD_URL}
  mkdir -p ${MONO_BUILD_PATH}
  mv *.tar.bz2 ${MONO_BUILD_PATH}
  cd ${MONO_BUILD_PATH} && tar xjf "${MONO_VERSION}.tar.bz2"

  echo "-----> STEP: (Re)Compiling Mono using monolite."
  cd "${MONO_BUILD_PATH}/mono-4.4.1"
  ./configure --enable-nls=no --prefix="${MONO_INSTALL_PATH}"
  make --silent get-monolite-latest
  make --silent
fi

echo "-----> STEP: Installing Mono at ${MONO_INSTALL_PATH}"
cd "${MONO_BUILD_PATH}/mono-4.4.1"
make --silent install

echo "-----> STEP: Setting symbolic links and paths."
ln -s "${MONO_INSTALL_PATH}" "/app"
MONO_LN_DIR="/app/mono"

export PATH="${MONO_LN_DIR}/bin:${PATH}"
export LD_LIBRARY_PATH="${MONO_LN_DIR}/lib:${LD_LIBRARY_PATH}"

echo ${PATH}
echo ${LD_LIBRARY_PATH}

echo "-----> STEP: Importing certificates from OS."
cert-sync --user "/etc/ssl/certs/ca-certificates.crt"

echo "-----> STEP: Checking the installation and version."
mono --version

if [ ! -d "${FSHARP_BUILD_PATH}" ]; then
  PATH="${MONO_INSTALL_PATH}/bin:${PATH}"
  LD_LIBRARY_PATH="${MONO_INSTALL_PATH}/lib:${LD_LIBRARY_PATH}"
  PKG_CONFIG_PATH="${MONO_INSTALL_PATH}/lib/pkgconfig"
  
  echo "-----> STEP: Download F# at ${MONO_BUILD_PATH}"
  cd "${MONO_BUILD_PATH}"
  wget -c "https://github.com/fsharp/fsharp/archive/${FSHARP_VERSION}.zip"
  unzip "*.zip"
  
  echo "-----> STEP: Compiling F#"
  cd ${FSHARP_BUILD_PATH}
  ./autogen.sh --prefix="${MONO_INSTALL_PATH}"
  make --silent
fi

echo "Installing F# at ${MONO_INSTALL_PATH}"
cd ${FSHARP_BUILD_PATH}
make install

echo "-----> STEP: Downloading nuget at: ${NUGET_INSTALL_PATH}"
mkdir -p "${NUGET_INSTALL_PATH}"
cd ${NUGET_INSTALL_PATH}
wget -c ${NUGET_DOWNLOAD_URL} && chmod +x nuget.exe

echo "-----> STEP: Installing project dependencies"
cd ${BUILD_DIR}
mono "${NUGET_INSTALL_PATH}/nuget.exe" restore

echo "-----> STEP: Compiling project"
cd ${BUILD_DIR}
xbuild /p:Configuration=Release
